# Домашнее задание к занятию «Резервное копирование баз данных». Потапчук Сергей.

**Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.** 

Для оформления вашего решения в GitHub можете воспользоваться [шаблоном](https://github.com/netology-code/sys-pattern-homework).

Название файла должно содержать номер лекции и фамилию студента. Пример названия: «12.8. Резервное копирование баз данных — Александр Александров».

Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы по решению задач задавайте в чате учебной группы.

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Решение

1.1 Выполнять полный бэкап базы данных один раз в сутки, например, ночью при минимальной нагрузке с помощью, например mysqldump для MySQL или pg_dump для PostgreSQL

1.2 Добавить к пункту 1.1 инкрементальное копирование изменений каждые 60 минут с помощью бинарных логов (MySQL binlog) или WAL-логов (PostgreSQL WAL archiving).

1.3 Создать репликацию БД или держать развернутую копию БД и раз в час загружать в нее изменения, тогда для отката просто переключиться на копию. 

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Решение

2.1
  2.1.1 Полное резервное копирование и восстановление базы данных в текстовом формате
  ```sql
  -- копирование базы данных
  pg_dump -h localhost -U postgres -d mydb > backup_mydb_$(date +%Y%m%d_%H%M).sql
  
  -- можно использовать флаг -C — добавить команду CREATE DATABASE, удобно при восстановлении на чистый сервер
  
  -- восстановление из резервной копии
  psql -h localhost -U postgres -d mydb < backup_mydb_20250914_1200.sql
  ```
  2.1.2 Полное резервное копирование и восстановление базы данных в бинарном формате (custom или directory)
  ```sql
  -- копирование базы данных в custom формат
  pg_dump -h localhost -U postgres -d mydb -F custom > backup_mydb_$(date +%Y%m%d_%H%M).custom

  -- копирование базы данных в виде директории
  pg_dump -h localhost -U postgres -d mydb -F directory -f /backups/mydb_dir

  -- восстановление из custom формата
  pg_restore -h localhost -U postgres -d mydb backup_mydb_20250914_1200.custom
  ```
  2.1.* Создать скрипт и запускать его с помощью cron, или лучше создать systemd сервис и запускатьего с помощью systemd таймера.
  
---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Решение

3.1. Инкрементное резервное копирование в MySQL невозможно без бинарных логов (binary logs) — это основа для фиксации всех изменений после полной резервной копии. 
```sql
-- cделать полную резервную копию
mysqldump -u root -p --single-transaction --flush-logs --all-databases > full_backup_$(date +%Y%m%d_%H%M).sql
```

Чтобы выполнить инкрементное резервное копирование, нужно скопировать все бинарные логи, созданные после полного бэкапа.
```Bash
cp /var/lib/mysql/mysql-bin.* /backups/binlogs/
```

Восстановление

```sql
-- восстановливаем полный бэкап
mysql -u root -p < full_backup_20250914_1200.sql

-- применяем бинарные логи по порядку
mysqlbinlog /backups/binlogs/mysql-bin.000003 | mysql -u root -p
mysqlbinlog /backups/binlogs/mysql-bin.000004 | mysql -u root -p
```

3.1.* Реплицирование не заменяет резервного копирования, т.к. оно не защищает от некорректного изменения данных (ошибка программы, человеческий фактор). Реплицирование защищает от поломок железа и ПО, на котором расположена БД (реплика должна находиться на другой физической ноде).

---

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.
